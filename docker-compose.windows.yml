version: '3.8'

# Windows Docker Stack for Omni.Thooft
# To use this stack:
# 1. Create a folder: Documents/Docker/
# 2. You can set the environment variable OMNI_DOCS_PATH to your Documents folder path.
#    Example: $env:OMNI_DOCS_PATH = "C:\Users\YourName\Documents\Docker"
# 3. Use 'stack.env' for credentials.

services:
  app:
    image: docker.io/geldofa/thooft_omni:latest
    ports:
      - "80:80"
    environment:
      - ADMIN_EMAIL=${ADMIN_EMAIL}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
    depends_on:
      - db
    restart: unless-stopped
    container_name: thooft_omni

  db:
    image: alpine:latest
    ports:
      - "8090:8090"
    volumes:
      # Map persistent data to the Windows Documents folder. Set OMNI_DOCS_PATH in stack.env.
      # Defaults to Public Documents if not set.
      - "${OMNI_DOCS_PATH:-C:\\Users\\Public\\Documents\\Docker}\\pb_data:/pb/pb_data"
      - "${OMNI_DOCS_PATH:-C:\\Users\\Public\\Documents\\Docker}\\pb_migrations:/pb/pb_migrations:ro"
      - "${OMNI_DOCS_PATH:-C:\\Users\\Public\\Documents\\Docker}\\pb_hooks:/pb/pb_hooks:ro"
    environment:
      - POCKETBASE_ADMIN_EMAIL=${ADMIN_EMAIL}
      - POCKETBASE_ADMIN_PASSWORD=${ADMIN_PASSWORD}
      - GDRIVE_CLIENT_ID=${GDRIVE_CLIENT_ID}
      - GDRIVE_CLIENT_SECRET=${GDRIVE_CLIENT_SECRET}
    restart: unless-stopped
    container_name: thooft_db
    depends_on:
      - rclone
    command: >
      sh -c '
        apk add --no-cache curl unzip ca-certificates &&
        curl -L https://github.com/pocketbase/pocketbase/releases/download/v0.23.12/pocketbase_0.23.12_linux_amd64.zip -o /tmp/pb.zip &&
        unzip -o /tmp/pb.zip -d /pb/ &&
        /pb/pocketbase superuser upsert "$${POCKETBASE_ADMIN_EMAIL}" "$${POCKETBASE_ADMIN_PASSWORD}" --dir=/pb/pb_data &&
        /pb/pocketbase migrate up --dir=/pb/pb_data --migrationsDir=/pb/pb_migrations &&
        chown -R root:root /pb/pb_data &&
        chmod -R 755 /pb/pb_data &&
        /pb/pocketbase serve --http=0.0.0.0:8090 --dir=/pb/pb_data --migrationsDir=/pb/pb_migrations --hooksDir=/pb/pb_hooks
      '

  rclone:
    image: rclone/rclone:latest
    container_name: thooft_rclone
    volumes:
      - "${OMNI_DOCS_PATH:-C:\\Users\\Public\\Documents\\Docker}\\pb_data\\rclone:/config/rclone"
      - "${OMNI_DOCS_PATH:-C:\\Users\\Public\\Documents\\Docker}\\pb_data\\backups:/backups"
    command: "rcd --rc-addr :5572 --rc-no-auth"
    restart: unless-stopped
