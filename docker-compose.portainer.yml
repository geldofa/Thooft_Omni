# Docker Compose Stack for Omni.Thooft
# Persistence is handled via named volumes for easier orchestration.

services:
  app:
    image: docker.io/geldofa/thooft_omni:latest
    ports:
      - "80:80"
    networks:
      default:
        aliases:
          - OMNI
          - OMNI.local
    environment:
      - ADMIN_EMAIL=${ADMIN_EMAIL}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
    depends_on:
      - db
    restart: unless-stopped
    container_name: thooft_omni

  db:
    image: alpine:latest
    ports:
      - "8090:8090"
    volumes:
      - pb_data:/pb/pb_data
      - ./pb_migrations:/pb/pb_migrations:ro
      - ./pb_hooks:/pb/pb_hooks:ro
    environment:
      - POCKETBASE_ADMIN_EMAIL=${ADMIN_EMAIL}
      - POCKETBASE_ADMIN_PASSWORD=${ADMIN_PASSWORD}
      - GDRIVE_CLIENT_ID=${GDRIVE_CLIENT_ID}
      - GDRIVE_CLIENT_SECRET=${GDRIVE_CLIENT_SECRET}
    restart: unless-stopped
    container_name: thooft_db
    depends_on:
      - rclone
    command: >
      sh -c '
        apk add --no-cache curl unzip ca-certificates &&
        curl -L https://github.com/pocketbase/pocketbase/releases/download/v0.23.12/pocketbase_0.23.12_linux_amd64.zip -o /tmp/pb.zip &&
        unzip -o /tmp/pb.zip -d /pb/ &&
        /pb/pocketbase superuser upsert "$${POCKETBASE_ADMIN_EMAIL}" "$${POCKETBASE_ADMIN_PASSWORD}" --dir=/pb/pb_data &&
        /pb/pocketbase migrate up --dir=/pb/pb_data --migrationsDir=/pb/pb_migrations &&
        chown -R root:root /pb/pb_data &&
        chmod -R 755 /pb/pb_data &&
        /pb/pocketbase serve --http=0.0.0.0:8090 --dir=/pb/pb_data --migrationsDir=/pb/pb_migrations --hooksDir=/pb/pb_hooks
      '

  rclone:
    image: rclone/rclone:latest
    container_name: thooft_rclone
    volumes:
      - pb_data_rclone:/config/rclone
      - pb_data_backups:/backups
    command: "rcd --rc-addr :5572 --rc-no-auth"
    restart: unless-stopped

volumes:
  pb_data:
  pb_data_rclone:
  pb_data_backups:
